at_tds=document.querySelectorAll(".available_t td");radio_longs=document.querySelectorAll("input[name='long']");time_mark=document.getElementsByClassName("time_mark")[0];time_mark_value="";room_radios=document.querySelectorAll(".new_form input[name='room']");me=getMe();rooms=getAllRooms();function clear_mark(){for(i=0;i<at_tds.length;i++)at_tds[i].innerHTML&&"disable"!=at_tds[i].className&&"weekday"!=at_tds[i].className&&(at_tds[i].className="")}function radio_onclick(){for(i=0;i<radio_longs.length;i++)radio_longs[i].onclick=function(){marked_time=$(".time_selected")[0];mark_change(marked_time,marked_time.parentNode.childNodes[1].attributes.name.value,marked_time.innerHTML,this.innerHTML)}}function mark_change(e,t,a){clear_mark();if(radio_longs[1].checked)if("disable"==e.nextElementSibling.className)alert("此时间无效！");else{e.className="time_selected";e.nextElementSibling.className="time_selected";time_mark_value=t+", "+a+", 2";time_mark.value=t+" "+a+":00"}else{e.className="time_selected";time_mark_value=t+", "+a+", 1";time_mark.value=t+" "+a+":00"}time_mark=document.getElementsByClassName("time_mark")[0];time_mark_value=time_mark_value.split(",");radio_onclick()}var r=-1;function updateContactPhone(){if($("input[type=number]")[0].value==me.contact)return 1;$.post("./../logic/backend.php","function=updateContact&contact="+$("input[type=number]")[0].value,function(e){if(1==e){console.log("个人信息保存success");r=1}else{console.log("个人信息保存failed");alert("联系信息保存失败");r=0}});return r}function submitApplication(){updateContactPhoneResult=updateContactPhone();if(1==updateContactPhoneResult){roomId=$("form")[0].id;$.post("./../logic/backend.php","function=submitApplication&time_mark="+$("form#"+roomId+" input")[0].value+"&long="+$("form#"+roomId+" input:checked")[1].value+"&room="+roomId+"&borrow_reason="+$("input[name=borrow_reason]")[0].value,function(e){if(1==e){node=$("td.time_selected");clear_mark();node.addClass("disable");updateSelectableButton();alert("预约成功！请按照预约时间前往预定场所\n您的预约可能由于办公需要被取消，请关注预约状态！\n为方便大家使用场地，请在使用场地完毕后，将场地布置恢复为借用前格局")}else alert("借用失败！无效的时间段申请，未填写借用理由或者用户状态非法")})}else alert("请检查下方个人信息和网络连接并重试")}function updateAvailableTime(e){$.post("./../logic/backend.php","function=getAvailableTimeRelatedToARoomInDefaultPeriod&room="+e,function(t){if(JSON.parse(t)){json=JSON.parse(t);clear_mark();$("form.new_form")[0].id=e;for(i=0;i<$("tr td.weekday").length;i++){day=$("tr td.weekday")[i].attributes.name.value;for(j=0;j<$("tr:eq("+i+") td:gt(0)").length;j++){node=$("tr:eq("+i+") td:eq("+(j+1)+")");json[day].indexOf(parseInt(node[0].innerHTML))>-1?node.removeClass("disable"):node.addClass("disable")}}updateSelectableButton();for(i=0;i<room_radios.length;i++){room_radio=room_radios[i];room_radio.prop("checked",!1)}$("p#roomPool input[value="+e+"]").prop("checked",!0)}else console.log("刷新可用时间失败，请刷新页面")})}all_orders=[];$.post("./../logic/backend.php","function=getAllLiveOrders",function(e){all_orders=json=JSON.parse(e)});function findBorrower(e,t){for(var a={},o=0;o<all_orders.length;o++){var i=all_orders[o];if(i.room.toString()==t&&e>=new Date(i.start.replace(/-/g,"/"))&&e<new Date(i.end.replace(/-/g,"/"))){a.username=getUserById(i.applicant).name;a.start=getHis(i.start);a.end=getHis(i.end);return a}}}function updateSelectableButton(){for(i=0;i<at_tds.length;i++){at_td=at_tds[i];if(at_td.innerHTML&&"disable"!=at_td.className&&"weekday"!=at_td.className){at_td.removeAttribute("tooltip");at_td.onclick=function(){mark_change(this,this.parentNode.childNodes[1].attributes.name.value,this.innerHTML)}}else{at_td.onclick=null;if("disable"==at_td.className){var e=at_td.parentNode.childNodes[1].attributes.name.value,t=at_td.innerHTML,a=findBorrower(new Date((e+" "+t).replace(/-/g,"/")),$("form.new_form")[0].id);a&&at_td.setAttribute("tooltip",a.username+" "+a.start+"-"+a.end)}}}}for(i=0;i<rooms.length;i++)$("p#roomPool").append('<label ><input name = "room" type = "radio" value = "'+rooms[i].id+'" '+(0==i?"checked":"")+' /><span onclick="updateAvailableTime('+rooms[i].id+');" id="'+rooms[i].id+'" > '+rooms[i].name+" </span ></label >");$("p#roomPool > label:first > span").click();updateSelectableButton();$("input[name=phone]")[0].value=me.contact;
