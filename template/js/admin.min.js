me=getMe();function editAvailable(e){date=$("li#"+e)[0].children[0].innerText;start=date+" "+$("li#"+e+" input[type=number]")[0].value+":00:00";end=date+" "+$("li#"+e+" input[type=number]")[1].value+":00:00";$.post("./../logic/backend.php","function=editAvailable&availableId="+e+"&start="+start+"&end="+end,function(e){1==e?alert("编辑成功"):alert("目标不存在")})}roomsList=getAllRooms();rooms={};for(i=0;i<roomsList.length;i++)rooms[roomsList[i].id]=roomsList[i];for(i=0;i<roomsList.length;i++){$("ul.admin_ul#rooms").append("<li>"+roomsList[i].name+"</li>");$("select#roomFilter").append('<option value="'+roomsList[i].id+'">'+roomsList[i].name+"</option>")}me.type<1&&$.post("./../logic/backend.php","function=getAllAvailablesInAPeriod",function(e){json=JSON.parse(e);if(json)for(i=0;i<json.length;i++)rooms[json[i].room]&&$("ul.admin_ul.work_time").append('<li id="'+json[i].id+'"><h5>'+getYmd(json[i].start)+"</h5><span >"+rooms[json[i].room].name+' </span><span class="time_label">开始：</span><input type="number" name="start" min="0" max="23" value="'+new Date(json[i].start.replace(/-/g,"/")).getHours()+'" step="1" /><span class="time_label">结束：</span><input type="number" name="end" min="0" max="23" value="'+new Date(json[i].end.replace(/-/g,"/")).getHours()+'" step="1" /><input type="button" value="修改" onclick="editAvailable('+json[i].id+');"/></li>');else alert("update availables error")});$.post("./../logic/backend.php","function=getAllBlacklistedUsers",function(e){json=JSON.parse(e);if(json)for(i=0;i<json.length;i++)$("ul.admin_ul.blacklist").append("<li id='"+json[i].id+"'>"+json[i].identifer+" "+json[i].name+'<ul class="borrow_item_btn"><li><a href="#" onclick="pardonUser('+json[i].id+');">移出</a></li></ul></li>');else alert("getBlacklistError")});all_orders=[];$.post("./../logic/backend.php","function=getAllLiveOrders",function(e){all_orders=json=JSON.parse(e);if(json)for(i=0;i<json.length;i++)$("ul.borrow_list").append('<li class="borrow_item" id="'+json[i].id+'"><header id="'+json[i].room+'"><h2>'+rooms[json[i].room.toString()].name+"</h2><h3>"+getYmd(json[i].start)+" "+getHis(json[i].start)+" - "+getHis(json[i].end)+'</h3></header><p>申请人：<span class="borrow_item_type">'+getUser(json[i].applicant).name+" 电话 "+getUser(json[i].applicant).contact+'</span>理由：<span class="borrow_item_type">'+json[i].reason+'</span>状态：<span class="borrow_item_type">'+("0"==json[i].state?"有效":"1"==json[i].state?"已撤回":"已取消")+'</span></p><ul class="borrow_item_btn">'+(new Date>new Date(json[i].end.replace(/-/g,"/"))?'<li><a href="#" onclick="reviewApplication('+json[i].applicant+", "+json[i].id+');">移到黑名单</a></li>':'<li><a href="#" onclick="cancelApplication('+json[i].id+')">取消预定</a></li>')+"</ul></li>");else alert("getOrdersError")});function pardonUser(e){$.post("./../logic/backend.php","function=pardonUser&targetId="+e,function(i){1==i?$("ul.admin_ul.blacklist li#"+e).remove():alert(i)})}function reviewApplication(e,i){$.post("./../logic/backend.php","function=reviewApplication&applicantId="+e+"&applicationId="+i,function(e){1==e?$("ul.borrow_list li#"+i).remove():alert(e)})}function cancelApplication(e){$.post("./../logic/backend.php","function=revokeApplication&applicationId="+e,function(i){1==i?$("ul.borrow_list li#"+e).remove():alert(i)})}window.users={};function getUser(e){if(!window.users[e]){user=getUserById(e);window.users[e]=user}return window.users[e]}function updateUserType(e){$.post("./../logic/backend.php","function=updateUserType&targetId="+e+"&type=2",function(e){1==e?alert("已成功将该用户提升为管理员"):alert(e)})}function queryUserByName(){$.post("./../logic/backend.php","function=queryUserByName&name="+$("#query_name").val(),function(e){if(users=JSON.parse(e)){users=JSON.parse(e);$("#user_queries").empty();for(var i=0;i<users.length;i++)$("#user_queries").append("<li>"+users[i].name+'<a href="#user_queries" onclick="updateUserType('+users[i].id+');">设为管理员</a></li>')}else alert("不存在相关用户")})}function filtAndHide(e,n,o){orders=function(){var t=[];for(i=0;i<all_orders.length;i++){var r=all_orders[i],s=!1;new Date>new Date(r.end.replace(/-/g,"/"))&&(s=!0);0!=e&&r.room!=e||!(n&&s||o&&!s)||t.push(i)}return t}();$("li.borrow_item").hide();orders.forEach(function(e){$("li.borrow_item:eq("+e+")").show()})}function updateFilter(){showExpired=$("input#expire")[0].checked;showFuture=$("input#future")[0].checked;roomId=$("select#roomFilter")[0].value;filtAndHide(roomId,showExpired,showFuture)}
